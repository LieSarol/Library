<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tutorial Page</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0d0d0d, #1a1a1a);
      color: #f0f0f0;
      padding: 20px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .back-btn {
      color: #ffffff;
      font-size: 22px;
      text-decoration: none;
    }

    h2, .query {
      font-weight: bold;
      font-size: 24px;
      color: #ffffff;
    }

    #responseBox {
      background: #0f0f0f;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #30363d;
    }

    .code-block {
      background-color: #161b22;
      padding: 15px;
      margin: 15px 0;
      border-radius: 10px;
      position: relative;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-x: auto;
    }

    .copy-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #8b949e;
      cursor: pointer;
    }

    .copy-icon:hover {
      color: #ffffff;
    }

    strong {
      color: #ffffff;
    }

    code {
      background-color: #222;
      padding: 2px 6px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 14px;
      color: #c9d1d9;
    }
  </style>
</head>
<body>

  <div class="topbar">
    <a href="search-page.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <h2>Tutorial</h2>
  </div>

  <div class="query" id="queryText">Loading query...</div>

  <div id="responseBox">Tutorial will appear her...</div>

  <script>
  const query = sessionStorage.getItem("searchQuery") || "No query found.";
  const preMessage = "Talk in Gen z and explain this thing in 700 letters:";
  const fullMessage = `${preMessage}\n\nQuestion: ${query}`;

  document.getElementById("queryText").innerText = "ðŸ”Ž " + query;

  window.onload = async () => {
    const responseBox = document.getElementById("responseBox");
    responseBox.innerHTML = "Loading...";

    try {
      // ðŸ§  1. Get Answer from AI
      const response = await fetch("https://library-of-knowledge.vercel.app/groq", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ message: fullMessage })
      });

      const data = await response.json();
      const raw = data.choices?.[0]?.message?.content || "No result returned.";
      responseBox.innerHTML = formatText(raw);

      // ðŸ§  2. Ask AI to detect niches
      const nichePrompt = `
From the user's question: "${query}", return the top 3 most relevant niche names as a JSON array. Pick ONLY from this list:

1. Language Learning
2. Mathematics
3. Science
4. Technology
5. Engineering
6. Art
7. Music
8. History
9. Geography
10. Philosophy
11. Psychology
12. Literature
13. Writing & Communication
14. Business & Entrepreneurship
15. Finance & Investing
16. Economics
17. Marketing
18. Sales
19. Public Speaking
20. Critical Thinking
21. Coding / Programming
22. Graphic Design
23. Web Development
24. App Development
25. Game Development
26. Animation
27. Video Production
28. Photography
29. Data Science
30. Artificial Intelligence
31. Cybersecurity
32. Robotics
33. Mechanics / Auto Repair
34. Architecture
35. Interior Design
36. Fashion Design
37. Cooking & Culinary Arts
38. Baking
39. Fitness & Exercise
40. Yoga & Mindfulness
41. Health & Nutrition
42. Self-Improvement
43. Time Management
44. Parenting Skills
45. Foreign Cultures & Travel
46. Astronomy
47. Biology
48. Chemistry
49. Physics
50. Environmental Studies
`;

      const nicheResponse = await fetch("https://library-of-knowledge.vercel.app/groq", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: nichePrompt })
      });

      const nicheData = await nicheResponse.json();
      const nicheArray = JSON.parse(nicheData.choices?.[0]?.message?.content || "[]");

      // ðŸ§  3. Insert into database
      await fetch("https://library-of-knowledge.vercel.app/insert", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          table: "qa_docs",
          question: query,
          answer: raw,
          niche: nicheArray
        })
      });

    } catch (err) {
      console.error(err);
      responseBox.innerText = "Error fetching response.";
    }
  };

  function formatText(text) {
    const lines = text.split('\n');
    let html = '';
    let insideCode = false;
    let codeBuffer = [];

    lines.forEach(line => {
      if (line.trim().startsWith("```")) {
        if (!insideCode) {
          insideCode = true;
          codeBuffer = [];
        } else {
          insideCode = false;
          const code = codeBuffer.join('\n');
          html += `
            <div class="code-block">
              <i class="fas fa-copy copy-icon" onclick="copyToClipboard(\`${code.replace(/`/g, "\\`")}\`)"></i>
              ${code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}
            </div>`;
        }
      } else if (insideCode) {
        codeBuffer.push(line);
      } else {
        const formatted = line
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/`([^`]+)`/g, '<code>$1</code>');
        html += `<p>${formatted}</p>`;
      }
    });

    return html;
  }

  function copyToClipboard(code) {
    navigator.clipboard.writeText(code).then(() => {
      alert("Copied!");
    });
  }
  </script>

</body>
</html>
