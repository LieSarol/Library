<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#3b82f6',
              darkbg: '#0f172a',
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-darkbg text-white min-h-screen flex items-center justify-center p-6 relative">
    
    <!-- Back Button -->
    <a href="/" class="absolute top-6 left-6 text-primary hover:text-blue-400 transition">
      <i class="fas fa-arrow-left text-2xl"></i>
    </a>

    <div class="bg-slate-800 p-6 rounded-2xl shadow-xl max-w-md w-full text-center space-y-4">
      <img
        id="avatar"
        src=""
        alt="Avatar"
        class="w-32 h-32 mx-auto rounded-full border-4 border-primary"
      />

      <!-- Joined -->
      <p id="joined" class="text-sm text-slate-400">Joined...</p>

      <!-- Editable Fields -->
      <form id="profileForm" class="space-y-3">
        <input
          id="username"
          type="text"
          maxlength="20"
          placeholder="Username"
          class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 ring-primary"
        />
        <textarea
          id="bio"
          maxlength="500"
          placeholder="Bio (max 500 characters)"
          class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 ring-primary resize-none"
        ></textarea>
        <input
          id="gender"
          type="text"
          placeholder="Gender"
          class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 ring-primary"
        />
        <input
          id="love_status"
          type="text"
          placeholder="Love status"
          class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 ring-primary"
        />
        <input
          id="crush_name"
          type="text"
          placeholder="Crush name"
          class="w-full px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 ring-primary"
        />
        <button
          type="submit"
          class="flex items-center justify-center gap-2 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg w-full transition"
        >
          <i class="fas fa-save"></i>
          Save Changes
        </button>
      </form>

      <p id="status" class="text-sm text-slate-300 mt-2"></p>
    </div>

    <script>
      const avatar = document.getElementById("avatar");
      const joined = document.getElementById("joined");
      const status = document.getElementById("status");

      const fields = ["username", "bio", "gender", "love_status", "crush_name"];
      const inputs = Object.fromEntries(fields.map(id => [id, document.getElementById(id)]));

      async function loadProfile() {
        try {
          const res = await fetch("https://sky.leapcell.app/me", {
            credentials: "include"
          });

          if (!res.ok) throw new Error("Failed to load profile");

          const data = await res.json();

          // Avatar & join date
          avatar.src = data.avatar || "";
          const createdAt = new Date(data.joined);
          const daysAgo = Math.floor((Date.now() - createdAt.getTime()) / (1000 * 60 * 60 * 24));
          joined.textContent = `Joined ${daysAgo === 0 ? "today" : daysAgo === 1 ? "yesterday" : `${daysAgo} days ago`}`;

          // Fill inputs
          fields.forEach(id => {
            if (inputs[id]) inputs[id].value = data[id] || "";
          });

        } catch (err) {
          console.error(err);
          status.textContent = "‚ùå Error loading profile.";
        }
      }

      document.getElementById("profileForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {};
        fields.forEach(id => {
          const val = inputs[id].value.trim();
          if (val !== "") payload[id] = val;
        });

        try {
          const res = await fetch("https://sky.leapcell.app/me/update", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(payload),
          });

          const data = await res.json();

          if (res.ok) {
            status.textContent = "‚úÖ Profile updated!";
          } else {
            const msg = data.errors ? data.errors.join(", ") : data.error;
            status.textContent = `‚ùå ${msg}`;
          }
        } catch (err) {
          console.error(err);
          status.textContent = "üî• Failed to update.";
        }
      });

      loadProfile();
    </script>
  </body>
</html>
