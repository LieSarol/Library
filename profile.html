<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            darkbg: '#0f172a',
            muted: '#94a3b8'
          },
        },
      },
    };
  </script>
  <script src="https://cdn.counter.dev/script.js" data-id="b63df5f3-bd46-4693-8a52-752add87cc69" data-utcoffset="8"></script>
</head>
<body class="bg-darkbg text-white min-h-screen flex items-center justify-center p-6 relative">

  <!-- Back Button -->
  <a href="/dashboard" class="absolute top-6 left-6 text-primary hover:text-blue-400 transition">
    <i class="fas fa-arrow-left text-2xl"></i>
  </a>

  <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-lg space-y-6">
    <!-- Header -->
    <div class="flex items-center gap-4">
      <img id="avatar" src="" class="w-20 h-20 rounded-full border-4 border-primary" />
      <div>
        <div class="flex items-center gap-2">
          <h2 id="username" class="text-xl font-bold">‚Äî</h2>
          <button onclick="editText('username', 20)" class="text-muted hover:text-primary"><i class="fas fa-pen"></i></button>
        </div>
        <p id="joined" class="text-sm text-muted">Joined...</p>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <div class="flex justify-between items-center">
          <span class="text-muted">Gender:</span>
          <span id="gender" class="text-right">‚Äî</span>
        </div>
        <button onclick="editDropdown('gender', ['Male', 'Female', 'Non-binary', 'Alien', 'Secret üëÄ'])"
          class="text-xs text-muted hover:text-primary float-right -mt-1"><i class="fas fa-pen"></i></button>
      </div>

      <div>
        <div class="flex justify-between items-center">
          <span class="text-muted">Status:</span>
          <span id="love_status" class="text-right">‚Äî</span>
        </div>
        <button onclick="editDropdown('love_status', ['Single', 'Taken', 'Crushing', 'It‚Äôs Complicated', 'Hiding üëÄ'])"
          class="text-xs text-muted hover:text-primary float-right -mt-1"><i class="fas fa-pen"></i></button>
      </div>

      <div class="col-span-2">
        <div class="flex justify-between items-center">
          <span class="text-muted">Fav Topic:</span>
          <span id="fav_topic" class="text-right">‚Äî</span>
        </div>
        <button onclick="editText('fav_topic', 50)" class="text-xs text-muted hover:text-primary float-right -mt-1"><i class="fas fa-pen"></i></button>
      </div>
    </div>

    <!-- Bio -->
    <div class="mt-4">
      <div class="flex justify-between items-center">
        <h3 class="text-sm text-muted">About Me</h3>
        <button onclick="editTextArea('bio', 500)" class="text-xs text-muted hover:text-primary"><i class="fas fa-pen"></i></button>
      </div>
      <p id="bio" class="text-sm whitespace-pre-line mt-2 bg-slate-700 p-3 rounded-lg min-h-[3rem]">‚Äî</p>
    </div>

    <div class="text-center pt-2">
      <button id="saveBtn" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
        <i class="fas fa-save mr-1"></i>Save Changes
      </button>
      <p id="status" class="text-xs text-muted mt-2"></p>
    </div>
  </div>

  <script>
    const fields = ["username", "bio", "gender", "love_status", "fav_topic"];
    const cache = {};

    async function loadProfile() {
      const res = await fetch("https://sky.leapcell.app/me", { credentials: "include" });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      document.getElementById("avatar").src = data.avatar || "";
      const daysAgo = Math.floor((Date.now() - new Date(data.joined)) / (1000 * 60 * 60 * 24));
      document.getElementById("joined").textContent = `Joined ${daysAgo === 0 ? 'today' : `${daysAgo} days ago`}`;

      fields.forEach(id => {
        document.getElementById(id).textContent = data[id] || "‚Äî";
        cache[id] = data[id] || "";
      });
    }

    function editText(id, maxLen = 50) {
      const p = document.getElementById(id);
      const value = p.textContent;
      const input = document.createElement("input");
      input.type = "text";
      input.value = value;
      input.maxLength = maxLen;
      input.className = "text-black px-2 py-1 rounded w-full mt-1";
      p.replaceWith(input);
      input.focus();

      input.addEventListener("blur", () => {
        const val = input.value.trim();
        const newP = document.createElement("span");
        newP.id = id;
        newP.textContent = val || "‚Äî";
        input.replaceWith(newP);
        cache[id] = val;
      });

      input.addEventListener("keydown", e => e.key === "Enter" && input.blur());
    }

    function editTextArea(id, maxLen = 500) {
      const p = document.getElementById(id);
      const value = p.textContent;
      const textarea = document.createElement("textarea");
      textarea.value = value;
      textarea.maxLength = maxLen;
      textarea.className = "text-black px-3 py-2 rounded w-full mt-2 resize-none";
      textarea.rows = 4;
      p.replaceWith(textarea);
      textarea.focus();

      textarea.addEventListener("blur", () => {
        const val = textarea.value.trim();
        const newP = document.createElement("p");
        newP.id = id;
        newP.textContent = val || "‚Äî";
        newP.className = "text-sm whitespace-pre-line mt-2 bg-slate-700 p-3 rounded-lg";
        textarea.replaceWith(newP);
        cache[id] = val;
      });
    }

    function editDropdown(id, options) {
      const p = document.getElementById(id);
      const currentVal = p.textContent;
      const dropdown = document.createElement("div");
      dropdown.className = "absolute z-50 mt-1 bg-slate-900 border border-primary rounded shadow-lg w-48";

      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.className = "block w-full text-left px-4 py-2 hover:bg-primary/20";
        btn.onclick = () => {
          p.textContent = opt;
          dropdown.remove();
          cache[id] = opt;
        };
        dropdown.appendChild(btn);
      });

      p.parentElement.appendChild(dropdown);
    }

    document.getElementById("saveBtn").addEventListener("click", async () => {
      const payload = {};
      fields.forEach(f => {
        const val = cache[f]?.trim();
        if (val) payload[f] = val;
      });

      const res = await fetch("https://sky.leapcell.app/me/update", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      document.getElementById("status").textContent = res.ok
        ? "‚úÖ Profile updated!"
        : `‚ùå ${data.error || data.errors?.join(", ")}`;
    });

    loadProfile().catch(err => {
      console.error(err);
      document.getElementById("status").textContent = "‚ùå Failed to load profile.";
    });
  </script>
</body>
  </html>
