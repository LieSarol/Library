<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ask Cubby</title>
  <style>
    * {
      font-family: sans-serif;
      box-sizing: border-box;
    }

    body {
      background: white;
      padding: 20px;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .box {
      background: #f3f3f3;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .label {
      font-weight: bold;
      margin-top: 20px;
      margin-bottom: 5px;
    }

    .noun-box span {
      display: inline-block;
      background: #eee;
      margin: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <input type="text" id="searchInput" placeholder="Ask me something..." onkeypress="if(event.key==='Enter') handleSearch()" />

  <div class="label" id="originalLabel" style="display:none;">Your question:</div>
  <div id="originalBox" class="box" style="display:none;"></div>

  <div class="label" id="nounLabel" style="display:none;">Nouns found:</div>
  <div class="noun-box" id="nounBox" style="display:none;"></div>

  <div class="label" id="relatedLabel" style="display:none;">Related questions:</div>
  <div id="resultsContainer"></div>

  <script>
    async function handleSearch() {
      const query = document.getElementById("searchInput").value.trim();
      if (!query) return;

      sessionStorage.setItem("searchQuery", query);

      // Reset boxes
      document.getElementById("originalBox").style.display = "none";
      document.getElementById("originalLabel").style.display = "none";
      document.getElementById("nounBox").style.display = "none";
      document.getElementById("nounLabel").style.display = "none";
      document.getElementById("resultsContainer").innerHTML = "";
      document.getElementById("relatedLabel").style.display = "none";

      // Check if exact question exists in DB
      const exists = await fetch(`https://library-of-knowledge.vercel.app/search?query=${encodeURIComponent(query)}&limit=1`)
        .then(res => res.json())
        .then(data => data.length > 0)
        .catch(() => false);

      // Show original question only if it DOESN'T exist
      if (!exists) {
        const originalBox = document.getElementById("originalBox");
        originalBox.textContent = query;
        originalBox.style.display = "block";
        document.getElementById("originalLabel").style.display = "block";
      }

      // Get nouns from Cubby
      const nouns = await fetch("https://cubby-noun-extrac-40.deno.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: query })
      })
      .then(res => res.json())
      .then(data => data.nouns || [])
      .catch(() => []);

      if (nouns.length > 0) {
        const nounBox = document.getElementById("nounBox");
        nounBox.innerHTML = nouns.map(n => `<span>${n}</span>`).join('');
        nounBox.style.display = "block";
        document.getElementById("nounLabel").style.display = "block";

        // Now search using the FIRST noun
        const related = await fetch(`https://your-api.com/search?query=${encodeURIComponent(nouns[0])}&limit=10`)
          .then(res => res.json())
          .catch(() => []);

        if (related.length > 0) {
          const container = document.getElementById("resultsContainer");
          related.forEach(item => {
            const div = document.createElement("div");
            div.className = "box";
            div.textContent = item.question;
            div.onclick = () => goToEndPage(item.question);
            container.appendChild(div);
          });
          document.getElementById("relatedLabel").style.display = "block";
        }
      }
    }

    function goToEndPage(question) {
      console.log("Clicked:", question);
      // You can update this if needed:
      // location.href = `/end-page?q=${encodeURIComponent(question)}`;
    }
  </script>

</body>
</html>
