<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Search Page</title>

  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />

  <style>
    body {
      background-color: #121212;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }

    /* Container for back button and search bar */
    .top-bar {
      display: flex;
      align-items: center;
      background-color: #1f1f1f;
      padding: 15px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    /* Back button style */
    .back-button {
      color: #00bfff;
      font-size: 1.5rem;
      cursor: pointer;
      margin-right: 15px;
      user-select: none;
    }

    .back-button:hover {
      color: #3399ff;
    }

    /* Search bar container with icon */
    .search-bar {
      flex: 1;
      display: flex;
      align-items: center;
      background-color: #2a2a2a;
      border-radius: 8px;
      padding: 8px 12px;
      box-shadow: inset 0 0 5px rgba(0,191,255,0.5);
    }

    /* Search icon inside the input */
    .search-icon {
      color: #00bfff;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 10px;
      user-select: none;
    }

    .search-bar input {
      width: 100%;
      border: none;
      background: transparent;
      color: #fff;
      font-size: 1rem;
      outline: none;
      user-select: text;
    }

    /* Section title styling */
    .section-title {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 30px;
      color: #aaa;
    }

    /* Hiding the "Related Results (Based on Noun)" title only */
    #nounResultsTitle {
      display: none;
    }

    /* Result box styles, now clickable */
    .result-box {
      margin: 15px auto;
      padding: 15px 20px;
      background-color: #1e1e1e;
      width: 80%;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      cursor: pointer;
      transition: background-color 0.3s ease;
      color: #fff;
      text-decoration: none; /* Remove underline */
      display: block; /* To make the whole div clickable */
    }

    .result-box:hover {
      background-color: #00bfff33;
    }

    /* Remove the separate link styles because the box itself is clickable */
    /* No separate <a> tags inside result-box now */

    .no-result {
      text-align: center;
      margin-top: 50px;
      font-size: 1.2rem;
      color: #bbb;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <!-- Back button -->
    <i class="fa-solid fa-arrow-left back-button" id="backBtn" title="Go Back"></i>

    <!-- Search bar with icon -->
    <div class="search-bar">
      <i class="fa-solid fa-magnifying-glass search-icon" id="searchIcon" title="Search"></i>
      <input type="text" id="searchInput" placeholder="Search..." />
    </div>
  </div>

  <div class="section-title">ðŸ”Ž Results for Your Search</div>
  <div id="queryResults"></div>

  <div class="section-title" id="nounResultsTitle">ðŸ§  Related Results (Based on Noun)</div>
  <div id="nounResults"></div>

  <script>
const CATEGORIES = [
  "Language Learning", "Mathematics", "Science", "Technology", "Engineering", "Art",
  "Music", "History", "Geography", "Philosophy", "Psychology", "Literature",
  "Writing & Communication", "Business & Entrepreneurship", "Finance & Investing", "Economics",
  "Marketing", "Sales", "Public Speaking", "Critical Thinking", "Coding / Programming",
  "Graphic Design", "Web Development", "App Development", "Game Development", "Animation",
  "Video Production", "Photography", "Data Science", "Artificial Intelligence", "Cybersecurity",
  "Robotics", "Mechanics / Auto Repair", "Architecture", "Interior Design", "Fashion Design",
  "Cooking & Culinary Arts", "Baking", "Fitness & Exercise", "Yoga & Mindfulness",
  "Health & Nutrition", "Self-Improvement", "Time Management", "Parenting Skills",
  "Foreign Cultures & Travel", "Astronomy", "Biology", "Chemistry", "Physics", "Environmental Studies",

  // 100 more ðŸ‘‡
  "Emotional Intelligence", "Personal Finance", "Leadership", "Teamwork", "Problem Solving",
  "Project Management", "Freelancing", "Remote Work", "Ethical Hacking", "Digital Marketing",
  "Search Engine Optimization", "Social Media Strategy", "Customer Service", "UX/UI Design",
  "3D Modeling", "Blockchain", "Virtual Reality", "Augmented Reality", "Product Management",
  "Startup Development", "E-commerce", "Content Creation", "Podcasting", "Blogging",
  "YouTube Strategy", "Career Development", "Job Interview Skills", "Resume Building", "Networking",
  "Emotional Resilience", "Stress Management", "Sleep Science", "Productivity Systems", "Goal Setting",
  "Habits & Discipline", "Decision Making", "Mindset Training", "Life Planning", "Creativity Techniques",
  "Memory Improvement", "Speed Reading", "Study Skills", "Learning How to Learn", "Note-Taking Systems",
  "Conflict Resolution", "Communication Skills", "Listening Skills", "Nonverbal Communication", "Persuasion Skills",
  "Negotiation", "Debate Skills", "Personal Branding", "Self-Confidence", "Digital Citizenship",
  "Internet Safety", "Online Privacy", "Civic Education", "Ethics & Morality", "Sociology",
  "Political Science", "Cultural Awareness", "Global Issues", "Sustainability", "Climate Awareness",
  "Conservation", "Public Health", "Nutrition Science", "Human Anatomy", "Genetics",
  "Neuroscience", "Microbiology", "Ecology", "Oceanography", "Meteorology",
  "Space Exploration", "Basic Electronics", "DIY Skills", "Home Maintenance", "Gardening",
  "Pet Care", "Hiking & Nature", "Survival Basics", "Martial Arts", "Dance",
  "Stage Performance", "Voice Training", "Music Theory", "Instrument Skills", "Singing Techniques",
  "Calligraphy", "Painting", "Sculpting", "Theater Arts", "Film Appreciation",
  "Classic Literature", "World Religions", "Spiritual Growth", "Love & Relationships", "Friendship",
  "Marriage & Partnerships", "Digital Relationships", "Identity Development", "Values & Beliefs", "Community Engagement"
];

let lastQuery = sessionStorage.getItem('searchQuery') || '';

function classifyAndStore(query) {
  const prompt = `
Classify the following question into ONE of the categories below. ONLY return the category name exactly as written:

Categories:
${CATEGORIES.map((c, i) => `${i + 1}. ${c}`).join('\n')}

Question: "${query}"
Category:
`;

  fetch('https://library-of-knowledge.vercel.app/groq', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: prompt })
  })
  .then(res => res.json())
  .then(data => {
    const reply = data.choices?.[0]?.message?.content?.trim();
    if (reply) {
      sessionStorage.setItem('nicheQuery', reply);
      console.log("ðŸŽ¯ Niche updated:", reply);
    } else {
      console.warn("ðŸ¤·â€â™‚ï¸ No category reply from API");
    }
  })
  .catch(err => {
    console.error("ðŸš¨ API error:", err);
  });
}

// Keep watchinâ€™ like Netflix ðŸ‘€
setInterval(() => {
  const currentQuery = sessionStorage.getItem('searchQuery') || '';
  if (currentQuery && currentQuery !== lastQuery) {
    lastQuery = currentQuery;
    classifyAndStore(currentQuery);
  }
}, 500); // every half sec
         </script>

  <script>
  const searchInput = document.getElementById('searchInput');
  const queryResults = document.getElementById('queryResults');
  const nounResults = document.getElementById('nounResults');
  const backBtn = document.getElementById('backBtn');
  const searchIcon = document.getElementById('searchIcon');

  const searchQuery = sessionStorage.getItem('searchQuery') || '';
  const nicheQuery = sessionStorage.getItem('nicheQuery') || '';
  searchInput.value = searchQuery;

  backBtn.addEventListener('click', () => {
    window.history.back();
  });

  // âœ… Moved OUTSIDE the function!
  searchIcon.addEventListener('click', triggerSearch);
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') triggerSearch();
  });

  function triggerSearch() {
    const query = searchInput.value.trim();
    if (!query) return;

    sessionStorage.setItem('searchQuery', query);

    if (query.endsWith('?')) {
      fetchExactSearchResults(query, queryResults);
    } else {
      queryResults.innerHTML = '<div class="no-result">Please end your query with a "?" for exact search.</div>';
    }

    if (nicheQuery) {
      fetchNicheResults(nicheQuery, nounResults);
    } else {
      nounResults.innerHTML = '<div class="no-result">No niche saved in sessionStorage.</div>';
    }
  }

  function renderResults(container, data) {
  container.innerHTML = data.map(item => {
    const isKing = item.count > 1000;
    return `
      <a href="redirect.html" class="result-box" data-xata-id="${item.xata_id}">
        <div>
          ${isKing ? '<i class="fas fa-crown" style="color: gold; margin-right: 6px;"></i>' : ''}
          ${item.question}
        </div>
      </a>
    `;
  }).join('');

  container.querySelectorAll('.result-box').forEach(box => {
    box.addEventListener('click', e => {
      const xataId = box.getAttribute('data-xata-id');
      if (xataId) {
        sessionStorage.setItem('selectedXataId', xataId);
        console.log('Saved xata_id:', xataId);
      }
    });
  });
  }

  async function fetchExactSearchResults(query, container) {
    try {
      const res = await fetch(`https://library-of-knowledge.vercel.app/search?q=${encodeURIComponent(query)}&limit=1`);
      const data = await res.json();

      if (data.message === 'No matching questions found.' || !Array.isArray(data) || data.length === 0) {
        container.innerHTML = `
          <a href="dynamic.html" class="result-box">
            <div>${query}</div>
          </a>
        `;
        return;
      }

      const exactExists = data.some(item => item.question.toLowerCase() === query.toLowerCase());
      renderResults(container, data);

      if (!exactExists) {
        container.insertAdjacentHTML('beforeend', `
          <a href="dynamic.html" class="result-box" style="background-color: #333; border: 2px dashed #00bfff; margin-top: 15px;">
            <div>Create new entry: <strong>${query}</strong></div>
          </a>
        `);
      }

    } catch (err) {
      console.error('Search failed:', err);
      container.innerHTML = '<div class="no-result">Error loading results.</div>';
    }
  }

  async function fetchNicheResults(niche, container) {
    try {
      const res = await fetch(`https://library-of-knowledge.vercel.app/flex/niche?niche=${encodeURIComponent(niche)}&limit=5`);
      if (!res.ok) {
        container.innerHTML = '<div class="no-result">No results found for this niche.</div>';
        return;
      }

      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<div class="no-result">No results found for this niche.</div>';
      } else {
        renderResults(container, data);
      }
    } catch (err) {
      console.error('Niche search failed:', err);
      container.innerHTML = '<div class="no-result">Error loading niche results.</div>';
    }
  }
    let lastNicheQuery = nicheQuery;

// Check every 500ms if nicheQuery has changed
setInterval(() => {
  const current = sessionStorage.getItem('nicheQuery');
  if (current !== lastNicheQuery) {
    lastNicheQuery = current;

    if (current) {
      fetchNicheResults(current, nounResults);
    } else {
      nounResults.innerHTML = '<div class="no-result">No niche saved in sessionStorage.</div>';
    }
  }
}, 500);

  // Initial load
if (searchQuery) {
  triggerSearch(); // ðŸ‘ˆ This will handle everything now
} else {
  queryResults.innerHTML = '<div class="no-result">No search query found.</div>';
}
  </script>

</body>
  </html>
